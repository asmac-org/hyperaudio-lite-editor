<!DOCTYPE html>
<html>
<head>
  <link rel="stylesheet" href="css/hyperaudio-lite-editor.css">
</head>
<body>
  <div style="margin-left:-8px"><h2>Transcribe</h2>
    <div>
      <form onsubmit="getData(event)">
        <div>
          <span>
            <div class="hidden-label-holder"><label for="token">Deepgram Token</label></div>
            <input type="text" id="token" name="token" size="30" placeholder="Deepgram token">
          </span>
        </div>
        <div>
          <div class="hidden-label-holder"><label for="token">link to media</label></div>
          <input type="text" id="media" name="media" size="30" placeholder="link to media">
          <div class="hidden-label-holder"><label for="language">link to media</label></div>
          <select id="language" name="language" placeholder="language">
          </select>
          <input type="submit" value="transcribe">
        </div>
      </form>
    </div>
  </div>
</body>
<script>

  function configureLanguage() {
    const select = document.querySelector('#language');
    const optionLanguage = {
      "English (United States)": "en-US",
      "English (Great Britain)": "en-GB",
      "Italian": "it",
      "Spanish": "es",
      "Chinese, Simplified Mandarin (China)": "zh-CN",
      "Chinese, Traditional Mandarin (Taiwan)": "zh-TW",
      "Dutch": "nl",
      "English (Australia)": "en-AU",
      "English (India)" : "en-IN",
      "English (New Zealand)" : "en-NZ",
      "French" : "fr",
      "French (Canada)" : "fr-CA",
      "German" : "de",
      "Hindi" : "hi",
      "Hindi (Latin Script)" : "hi-Latn",
      "Indonesian" : "id",
      "Japanese" : "ja",
      "Korean" : "ko",
      "Polish" : "pl",
      "Portuguese": "pt",
      "Portuguese (Brazil)" : "pt-BR",
      "Portuguese (Portugal)" : "pt-PT",
      "Russian" : "ru",
      "Spanish" : "es",
      "Swedish" : "sv",
      "Turkish" : "tr",
      "Ukrainian": "uk",
      }

    let counter = 0
    Object.keys(optionLanguage).forEach( language => {
      //console.log(language)
      let option = document.createElement("option")
      option.value = optionLanguage[language]
      option.innerHTML = `<span>${language}<span>`
      if (counter === 0) {
        option.selected = "selected"
      }
      select.appendChild(option)
      counter += 1

    } )
  }

  configureLanguage();

  function getData(event) {

    //document.querySelector("#editor").contentWindow.document.querySelector('#hypertranscript').innerHTML = 'Transcribing...<br/><img src="rings.svg" width="50" alt="" style="margin: auto; display: block;">';
    parent.document.querySelector('#hypertranscript').innerHTML = '<div class="vertically-centre"><center>Transcribing....</center><br/><img src="rings.svg" width="50" alt="transcribing" style="margin: auto; display: block;"></div>';
    const language = document.querySelector('#language').value;
    const  media =  document.querySelector('#media').value;
    const  token =  document.querySelector('#token').value;
    let tier = "enhanced";

    if (media !== "" || token !== "") {

      //let player = document.querySelector("#editor").contentWindow.document.querySelector("#hyperplayer");
      let player = parent.document.querySelector("#hyperplayer");
      player.src = media;
      fetchData(token, media, tier, language);
    } else {
      parent.document.querySelector('#hypertranscript').innerHTML = '<div class="vertically-centre"><img src="error.svg" width="50" alt="error" style="margin: auto; display: block;"><br/><center>Please include both a link to the media and token in the form. </center></div>';
    }

    event.preventDefault();
    return false;
  }

  function fetchData(token, media, tier, language) {
    fetch(`https://api.deepgram.com/v1/listen?model=general&tier=${tier}&punctuate=true&diarize=true&language=${language}`, {
      method: 'POST',
      headers: {
        'Authorization': 'Token '+token+'',
        'content-type': 'application/json'
      },
      body: JSON.stringify({
        'url': media
      })
    })
    .then(response => {
      if (!response.ok) {
        throw new Error(response.status);
      } else {
        console.log("response ok");
      }
      
      return response.json();
    })
    .then(json => {
      parseData(json);
    })
    .catch(function (error) {
      console.dir("error is : "+error);
      error = error + "";

      if (error.indexOf("401") > 0 || (error.indexOf("400") > 0 && tier === "base")) {
        parent.document.querySelector('#hypertranscript').innerHTML = '<div class="vertically-centre"><img src="error.svg" width="50" alt="error" style="margin: auto; display: block;"><br/><center>Sorry.<br/>It appears that the media URL does not exist<br/> or the token is invalid.</center></div>';
      }
      
      if (error.indexOf("400") > 0 && tier === "enhanced") {
        tier = "base";
        fetchData(token, media, tier, language);
      }

      this.dataError = true;
      document.querySelector("#editor").contentWindow.document.querySelector('#hypertranscript').innerHTML = ''; 
      parent.document.querySelector('#hypertranscript').innerHTML = ''; 
    })
  }

  function parseData(json) {
    this.users = json;

    console.log(json);

    const maxWordsInPara = 100;
    const significantGapInSeconds = 0.5;

    const punctuatedWords = json.results.channels[0].alternatives[0].transcript.split(' ');
    const wordData = json.results.channels[0].alternatives[0].words;

    let hyperTranscript = "<article>\n <section>\n  <p>\n   ";

    let previousElementEnd = 0;
    let wordsInPara = 0;
    let showDiarization = true;

    wordData.forEach((element, index) => {

      let currentWord = punctuatedWords[index];
      wordsInPara++;

      // if there's a gap longer than half a second consider splitting into new para

      if (previousElementEnd !== 0 && (element.start - previousElementEnd) > significantGapInSeconds || wordsInPara > maxWordsInPara){
        let previousWord = punctuatedWords[index-1];
        let previousWordLastChar = previousWord.charAt(previousWord.length-1);
        if (previousWordLastChar === "." || previousWordLastChar === "?" || previousWordLastChar === "!") {
          hyperTranscript += "\n  </p>\n  <p>\n   ";
          wordsInPara = 0;
        }
      }

      // change of speaker or first word
      if ((showDiarization === true && index > 0 && element.speaker !== wordData[index-1].speaker) || index === 0) { 
        let previousWord = punctuatedWords[index-1];
        let previousWordLastChar = null;
        
        if (index > 0) {
          previousWordLastChar = previousWord.charAt(previousWord.length-1);
        }

        if (index > 0 && (previousWordLastChar === "." || previousWordLastChar === "?" || previousWordLastChar === "!")) {
          hyperTranscript += "\n  </p>\n  <p>\n   ";
          wordsInPara = 0;
        }
        hyperTranscript += `<span class="speaker" data-m='${element.start.toFixed(2)*1000}' data-d='0'>[speaker-${element.speaker}] </span>`;
      }

      hyperTranscript += `<span data-m='${element.start.toFixed(2)*1000}' data-d='${(element.end - element.start).toFixed(2)*1000}'>${currentWord} </span>`;

      previousElementEnd = element.end;
    });

    hyperTranscript +=  "\n </p> \n </section>\n</article>\n ";

    //document.querySelector("#editor").contentWindow.document.querySelector("#hypertranscript").innerHTML = hyperTranscript;
    parent.document.querySelector("#hypertranscript").innerHTML = hyperTranscript;
    //document.querySelector("#editor").contentWindow.hyperaudio();

    let showSpeakers = parent.document.querySelector('#show-speakers');
    let speakers = parent.document.querySelectorAll('.speaker');

    if (showSpeakers.checked === true) {
      speakers.forEach((speaker) => {
        speaker.style.display = "inline";
      });
    } else {
      speakers.forEach((speaker) => {
        speaker.style.display = "none";
      });
    }


    const event = new CustomEvent('hyperaudioInit');
    window.parent.document.dispatchEvent(event);
  }
</script>

<!-- service worker script for PWA -->
<script>
	window.addEventListener('load', () => {
	  registerSW();
	});

	// Register the Service Worker
	async function registerSW() {
    if ('serviceWorker' in navigator) {
      try {
      await navigator
          .serviceWorker
          .register('serviceworker.js');
      }
      catch (e) {
      console.log('SW registration failed');
      }
    }
	}
</script>

</html>