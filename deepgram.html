<html>
<body>
<head>
  <link rel="stylesheet" href="css/hyperaudio-lite-editor.css">
</head>
  <h3>Hyperaudio Lite Editor &mdash; Deepgram Integration Demo</h3>
  <div style="height:80px; position: top;">
    <form onsubmit="getData(event)" style="float:right">
      <input type="text" id="media" name="media" size="30" placeholder="media">
      <input type="text" id="token" name="token" size="30" placeholder="token">
      <input type="submit" value="transcribe">
    </form>
  </div>
  <iframe id="editor" width="100%" height="100%" style="border:0"  src="index.html"></iframe>
</body>
<script>
  function getData(event) {

    document.querySelector("#editor").contentWindow.document.querySelector('#hypertranscript').innerHTML = "Transcribing...";

    const  media =  document.querySelector('#media').value;
    const  token =  document.querySelector('#token').value;

    if (media !== "" || token !== "") {
      document.querySelector("#editor").contentWindow.document.querySelector("#hypertranscript").src = media;
      fetch('https://api.deepgram.com/v1/listen?model=general&tier=enhanced&punctuate=true', {
        method: 'POST',
        headers: {
            'Authorization': 'Token '+token+'',
            'content-type': 'application/json'
        },
        body: JSON.stringify({
            'url': media
        })
      })
      .then(response => {
        if (!response.ok) {
            throw new Error("HTTP error " + response.status);
            console.log("HTTP error " + response.status);
        }
        return response.json();
      })
      .then(json => {
        parseData(json);
      })
      .catch(function () {
        this.dataError = true;
      })
    } else { // test data
      document.querySelector('#hyperplayer').src = "https://lab.hyperaud.io/demos/hyperaudio-lite-back-to-basics-cbr/Software_Unscripted_36_Back_to_Basics_in_Production_with_Marc_Grabanksi_MIX.mp3";
      fetch("test.json")
      .then(res => res.json())
      .then(json => {
        parseData(json);
        //setTimeout(parseData(json), 1);
      })
    }

    event.preventDefault();
    return false;
  }

  function parseData(json) {
    this.users = json;

    const punctuatedWords = json.results.channels[0].alternatives[0].transcript.split(' ');
    const wordData = json.results.channels[0].alternatives[0].words;

    let hyperTranscript = "<article>\n <section>\n  <p>\n   ";

    let previousElementEnd = 0;

    wordData.forEach((element, index) => {

      if (previousElementEnd !== 0 && (element.start - previousElementEnd) > 0.5){
        hyperTranscript += "\n  </p>\n  <p>\n   ";
      } 

      hyperTranscript += `<span data-m='${element.start.toFixed(2)*1000}' data-d='${(element.end - element.start).toFixed(2)*1000}'>${punctuatedWords[index]} </span>`;

      previousElementEnd = element.end;
    });

    hyperTranscript +=  "\n </p> \n </section>\n</article>\n ";

    document.querySelector("#editor").contentWindow.document.querySelector("#hypertranscript").innerHTML = hyperTranscript;
    document.querySelector("#editor").contentWindow.hyperaudio();
  }
</script>
</html>