<!DOCTYPE html>
<html>
<head>
  <link rel="stylesheet" href="css/hyperaudio-lite-editor.css">

  <!-- Meta Tags required for
    Progressive Web App -->
  <meta name= "apple-mobile-web-app-status-bar" content="#aa7700">
  <meta name="theme-color" content="black">

  <!-- Manifest File link -->
  <link rel="manifest" href="manifest.json">

</head>
<body style="position:absolute; top: 0px; bottom: 0px; width: 98%; overflow-y:hidden; background-color: #ededed";">
  <dialog id="error-dialog">
    <p>Token or media URL not valid.</p>
    <form method="dialog">
      <button>OK</button>
    </form>
  </dialog>
  <div style="height:80px; margin-top:30px">
    <h4 style="padding-left:8px; margin: 0">Hyperaudio Lite Editor &mdash; Deepgram Demo</h4>
  
    <form onsubmit="getData(event)" style="float:right; margin-top:4px">
      <div style="float:right; margin-top: -40px; padding-bottom: 40px;">
        <input type="text" id="token" name="token" size="30" placeholder="token">
        <select id="language" id="language" placeholder="language">
        </select>
      </div>
      <div style="display: block; ">
        <span style="float:right; margin-top:-20px; padding-bottom: 10px;">
        <input type="text" id="media" name="media" size="30" placeholder="media">
        <input type="submit" value="transcribe">
        </span>
      </div>
    </form>
  </div>
  <iframe id="editor" width="100%" height="90%" style="border:0;"  src="localstorage.html"></iframe>
</body>
<script>

  function configureLanguage() {
    const select = document.querySelector('#language');
    const optionLanguage = {
      "English (United States)": "en-US",
      "English (Great Britain)": "en-GB",
      "Italian": "it",
      "Spanish": "es",
      "Chinese, Simplified Mandarin (China)": "zh-CN",
      "Chinese, Traditional Mandarin (Taiwan)": "zh-TW",
      "Dutch": "nl",
      "English (Australia)": "en-AU",
      "English (India)" : "en-IN",
      "English (New Zealand)" : "en-NZ",
      "French" : "fr",
      "French (Canada)" : "fr-CA",
      "German" : "de",
      "Hindi" : "hi",
      "Hindi (Latin Script)" : "hi-Latn",
      "Indonesian" : "id",
      "Japanese" : "ja",
      "Korean" : "ko",
      "Polish" : "pl",
      "Portuguese": "pt",
      "Portuguese (Brazil)" : "pt-BR",
      "Portuguese (Portugal)" : "pt-PT",
      "Russian" : "ru",
      "Spanish" : "es",
      "Swedish" : "sv",
      "Turkish" : "tr",
      "Ukrainian": "uk",
      }

    let counter = 0
    Object.keys(optionLanguage).forEach( language => {
      //console.log(language)
      let option = document.createElement("option")
      option.value = optionLanguage[language]
      option.innerHTML = `<span>${language}<span>`
      if (counter === 0) {
        option.selected = "selected"
      }
      select.appendChild(option)
      counter += 1

    } )
  }

  configureLanguage();

  function getData(event) {

    document.querySelector("#editor").contentWindow.document.querySelector('#hypertranscript').innerHTML = 'Transcribing...<br/><img src="rings.svg" width="50" alt="" style="margin: auto; display: block;">';
    const language = document.querySelector('#language').value;
    const  media =  document.querySelector('#media').value;
    const  token =  document.querySelector('#token').value;
    let tier = "enhanced";

    if (media !== "" || token !== "") {

      let player = document.querySelector("#editor").contentWindow.document.querySelector("#hyperplayer");

      player.src = media;

      fetchData(token, media, tier, language);

    } else { // test data
      document.querySelector('#hyperplayer').src = "https://lab.hyperaud.io/demos/hyperaudio-lite-back-to-basics-cbr/Software_Unscripted_36_Back_to_Basics_in_Production_with_Marc_Grabanksi_MIX.mp3";
      fetch("test.json")
      .then(res => res.json())
      .then(json => {
        parseData(json);
        //setTimeout(parseData(json), 1);
      })
    }

    event.preventDefault();
    return false;
  }

  function fetchData(token, media, tier, language) {
    fetch(`https://api.deepgram.com/v1/listen?model=general&tier=${tier}&punctuate=true&language=${language}`, {
      method: 'POST',
      headers: {
        'Authorization': 'Token '+token+'',
        'content-type': 'application/json'
      },
      body: JSON.stringify({
        'url': media
      })
    })
    .then(response => {
      if (!response.ok) {
        throw new Error(response.status);
      } else {
        console.log("response ok");
      }
      
      return response.json();
    })
    .then(json => {
      parseData(json);
    })
    .catch(function (error) {
      console.dir("error is : "+error);
      error = error + "";

      if (error.indexOf("401") > 0) {
        document.querySelector('#error-dialog').showModal();
      }
      
      if (error.indexOf("400") > 0 && tier === "enhanced") {
        tier = "base";
        fetchData(token, media, tier, language);
      }
      this.dataError = true;
      document.querySelector("#editor").contentWindow.document.querySelector('#hypertranscript').innerHTML = ''; 
    })
  }

  function parseData(json) {
    this.users = json;

    const maxWordsInPara = 100;
    const significantGapInSeconds = 0.5;

    const punctuatedWords = json.results.channels[0].alternatives[0].transcript.split(' ');
    const wordData = json.results.channels[0].alternatives[0].words;

    let hyperTranscript = "<article>\n <section>\n  <p>\n   ";

    let previousElementEnd = 0;
    let wordsInPara = 0;

    wordData.forEach((element, index) => {

      let currentWord = punctuatedWords[index];
      wordsInPara++;

      // if there's a gap longer than half a second consider splitting into new para

      if (previousElementEnd !== 0 && (element.start - previousElementEnd) > significantGapInSeconds || wordsInPara > maxWordsInPara){
        let previousWord = punctuatedWords[index-1];
        let previousWordLastChar = previousWord.charAt(previousWord.length-1);
        if (previousWordLastChar === "." || previousWordLastChar === "?" || previousWordLastChar === "!") {
          hyperTranscript += "\n  </p>\n  <p>\n   ";
            wordsInPara = 0;
        }
      }

      hyperTranscript += `<span data-m='${element.start.toFixed(2)*1000}' data-d='${(element.end - element.start).toFixed(2)*1000}'>${currentWord} </span>`;

      previousElementEnd = element.end;
    });

    hyperTranscript +=  "\n </p> \n </section>\n</article>\n ";

    document.querySelector("#editor").contentWindow.document.querySelector("#hypertranscript").innerHTML = hyperTranscript;
    document.querySelector("#editor").contentWindow.hyperaudio();
  }
</script>

<!-- service worker script for PWA -->
<script>
	window.addEventListener('load', () => {
	  registerSW();
	});

	// Register the Service Worker
	async function registerSW() {
    if ('serviceWorker' in navigator) {
      try {
      await navigator
          .serviceWorker
          .register('serviceworker.js');
      }
      catch (e) {
      console.log('SW registration failed');
      }
    }
	}
</script>

</html>